name: Build

on:
  push:
    branches: ['main']
    tags: ['release-*-*']
  pull_request:
    branches: ['main']

jobs:

  test:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    - uses: actions/setup-node@v6
    - name: install assembler
      run: sudo apt install xa65
    - name: make test
      run: make test
  
  build:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    - name: install dependencies
      run: sudo apt install gcc-mingw-w64 xa65
    - name: make (blobs)
      run: make --directory=./src/6502 aambox_frontend.bin c64_crunched.bin c64_drivecode.bin c64_loader.prg
    - name: make (linux)
      run: make --directory=./src aamshow aambundle
    - name: make (windows)
      run: make --directory=./src aamshow.exe aambundle.exe
    - uses: actions/upload-artifact@v4
      with:
        name: linux-x86_64
        path: |
          src/aamshow
          src/aambundle
    - uses: actions/upload-artifact@v4
      with:
        name: win32
        path: |
          src/aamshow.exe
          src/aambundle.exe
  
  release:
    runs-on: ubuntu-latest
    needs: ['test', 'build']
    permissions:
      contents: write
      packages: read
    steps:
      # TODO: check that the tag matches the version number in the files
      - uses: actions/checkout@v4
      - uses: actions/download-artifact@v4
        with:
          path: artifacts
      - name: assemble release bundle
        run: |
          # Determine the bundle name, and save it in the persistent environment
          if [[ "$GITHUB_REF_NAME" == release-* ]]; then
            BUNDLE=$(echo "$GITHUB_REF_NAME" | sed 's/^release-/aamachine-/')
          else
            BUNDLE="aamachine-prerelease"
          fi
          echo "AAMACHINE_BUNDLE_NAME=$BUNDLE" >> "$GITHUB_ENV"
          cat "$GITHUB_ENV"
          # Create the bundle and add the prebuild binaries in
          mkdir -p "$BUNDLE/prebuilt"
          mv artifacts/linux-x86_64 "$BUNDLE/prebuilt/"
          mv artifacts/win32 "$BUNDLE/prebuilt/"
          chmod +x "$BUNDLE"/prebuilt/*/*
          cp --recursive src "$BUNDLE/"
          cp --recursive docs "$BUNDLE/"
          cp --recursive example "$BUNDLE/"
          cp *.txt "$BUNDLE"/
          # Group them together in a single zip
          zip -r "$BUNDLE".zip "$BUNDLE"
      - uses: actions/upload-artifact@v4
        with:
          name: aamachine-release
          path: ${{ env.AAMACHINE_BUNDLE_NAME }}.zip
      - uses: softprops/action-gh-release@v2
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: |
            ${{ env.AAMACHINE_BUNDLE_NAME }}.zip
          body: >
            This is a release of the Ã…-machine tools and documentation.
          draft: true
          generate_release_notes: true
